// =========================
// Enums
// =========================
Enum UserRole {
  CONSUMER
  SELLER
  ADMIN
}

Enum CategoryType {
  POPUP
  CONSUMER
}

Enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

Enum AnnouncementAudience {
  ALL
  SELLER     // 통일: VENDOR -> SELLER
  CONSUMER   // 통일: USER -> CONSUMER
}

Enum EventAction {
  VIEW
  FAVORITE
  REVIEW
  CLICK
}

Enum DecisionType {
  APPROVE
  REJECT
}

Enum ApprovalTargetType {
  POPUP
}

// =========================
// Users & Profiles
// =========================
Table users {
  id               bigint [pk, increment]
  login_id         varchar(100) [not null, unique]
  password         varchar(255) [not null]
  name             varchar(100)
  nickname         varchar(100)
  email            varchar(255) [not null, unique]
  role             varchar(20)  [not null, note: 'UserRole']
  age_group        int          // CHANGED: consumer_profile 제거 후 이관 (10,20,30...)
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
}

// (REMOVED) Table consumer_profile

Table seller_profile {
  user_id           bigint [pk, ref: > users.id]
  profile_image_url varchar(500)
  introduction      varchar(500)  // 길이 통일
  activity_region   varchar(100)
  sns_url           varchar(200)
  created_at        datetime [default: `CURRENT_TIMESTAMP`]
  updated_at        datetime [default: `CURRENT_TIMESTAMP`]
}

// =========================
// Master
// =========================
Table category {
  id               bigint [pk, increment]
  name             varchar(100) [not null]
  type             varchar(20)  [not null, note: 'CategoryType']
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (type, name) [unique, name: "uk_category_type_name"]
  }
}

Table style {
  id               bigint [pk, increment]
  name             varchar(100) [not null, unique]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
}

Table region {
  id               bigint [pk, increment]
  name             varchar(100) [not null, unique]  // 남구/동구/서구/북구&광산구...
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
}

Table feature {
  id               bigint [pk, increment]
  name             varchar(100) [not null, unique]  // 무료주차/무료입장/예약가능/굿즈판매
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
}

// =========================
// Geo (ZoneArea / ZoneCell / Availability)
// =========================
Table zone_area {
  id               bigint [pk, increment]
  region_id        bigint [not null, ref: > region.id]
  name             varchar(100) [not null]
  geometry_data    text                         // GeoJSON/WKT
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (region_id) [name: "idx_zone_area_region"]
  }
}

Table zone_cell {
  id               bigint [pk, increment]
  zone_area_id     bigint [not null, ref: > zone_area.id]
  label            varchar(100)                 // 셀 라벨
  detailed_address varchar(255)
  lat              double
  lng              double
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (zone_area_id) [name: "idx_zone_cell_area"]
  }
}

Table zone_availability {
  id                     bigint [pk, increment]
  zone_cell_id           bigint [not null, ref: > zone_cell.id]
  start_date             date   [not null]
  end_date               date   [not null]
  daily_price            decimal(14,2) [not null]
  max_concurrent_slots   int [not null, default: 1]
  status                 varchar(20) [not null, default: 'ACTIVE']
  created_at             datetime [default: `CURRENT_TIMESTAMP`]
  updated_at             datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (zone_cell_id, start_date, end_date) [name: "idx_zone_avail_range"]
  }
}

// =========================
// Popup
// =========================
Table popup {
  id               bigint [pk, increment]
  seller_id        bigint [not null, ref: > users.id]
  zone_cell_id     bigint [not null, ref: > zone_cell.id]
  name             varchar(200) [not null]
  description      text
  start_date       date
  end_date         date
  operating_time   varchar(50)
  approval_status  varchar(20) [not null, default: 'PENDING', note: 'ApprovalStatus']
  rejection_reason varchar(500)
  view_count       bigint [not null, default: 0]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  updated_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (seller_id) [name: "idx_popup_seller"]
    (zone_cell_id) [name: "idx_popup_cell"]
    (approval_status) [name: "idx_popup_status"]
    (start_date, end_date) [name: "idx_popup_period"]
  }
}

Table popup_image {
  id               bigint [pk, increment]
  popup_id         bigint [not null, ref: > popup.id]
  image_url        varchar(500) [not null]
  is_thumbnail     boolean [not null, default: false]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (popup_id, is_thumbnail) [name: "idx_popup_img_thumb"]
  }
}

// =========================
// Preferences (M:N)
// =========================
Table user_pref_category {
  id               bigint [pk, increment]
  user_id          bigint [not null, ref: > users.id]
  category_id      bigint [not null, ref: > category.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (user_id, category_id) [unique, name: "uk_user_category"]
  }
}

Table user_pref_style {
  id               bigint [pk, increment]
  user_id          bigint [not null, ref: > users.id]
  style_id         bigint [not null, ref: > style.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (user_id, style_id) [unique, name: "uk_user_style"]
  }
}

Table user_pref_region {
  id               bigint [pk, increment]
  user_id          bigint [not null, ref: > users.id]
  region_id        bigint [not null, ref: > region.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (user_id, region_id) [unique, name: "uk_user_region"]
  }
}

// ✅ 추가: 소비자 편의 선호
Table user_pref_feature {
  id               bigint [pk, increment]
  user_id          bigint [not null, ref: > users.id]
  feature_id       bigint [not null, ref: > feature.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (user_id, feature_id) [unique, name: "uk_user_feature"]
  }
}

// =========================
// Popup M:N (join tables)
// =========================
Table popup_category {
  id               bigint [pk, increment]
  popup_id         bigint [not null, ref: > popup.id]
  category_id      bigint [not null, ref: > category.id]
  category_role    varchar(20) [not null] // POPUP or TARGET (구분)
  Indexes {
    (popup_id, category_id, category_role) [unique, name: "uk_popup_category"]
  }
}

Table popup_feature {
  id               bigint [pk, increment]
  popup_id         bigint [not null, ref: > popup.id]
  feature_id       bigint [not null, ref: > feature.id]
  Indexes {
    (popup_id, feature_id) [unique, name: "uk_popup_feature"]
  }
}

// ✅ 추가: 팝업 스타일 태그
Table popup_style {
  id               bigint [pk, increment]
  popup_id         bigint [not null, ref: > popup.id]
  style_id         bigint [not null, ref: > style.id]
  Indexes {
    (popup_id, style_id) [unique, name: "uk_popup_style"]
  }
}

// =========================
// Social
// =========================
Table wishlist {
  id               bigint [pk, increment]
  user_id          bigint [not null, ref: > users.id]
  popup_id         bigint [not null, ref: > popup.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (user_id, popup_id) [unique, name: "uk_wishlist"]
  }
}

Table review {
  id               bigint [pk, increment]
  consumer_id      bigint [not null, ref: > users.id]
  popup_id         bigint [not null, ref: > popup.id]
  rating           tinyint [not null]
  content          varchar(150)
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (consumer_id, popup_id) [unique, name: "uk_review_once"]
    (popup_id, rating, created_at) [name: "idx_review_sort"]
  }
}

Table review_image {
  id               bigint [pk, increment]
  review_id        bigint [not null, ref: > review.id]
  image_url        varchar(500) [not null]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (review_id) [name: "idx_review_img_review"]
  }
}

// =========================
// Messaging & Announcement
// =========================
Table message {
  id               bigint [pk, increment]
  sender_id        bigint [not null, ref: > users.id]
  receiver_id      bigint [not null, ref: > users.id]
  title            varchar(200) [not null]
  content          text
  sent_at          datetime [default: `CURRENT_TIMESTAMP`]
  read_at          datetime
  Indexes {
    (receiver_id, read_at) [name: "idx_msg_inbox"]
  }
}

Table message_attachment {
  id               bigint [pk, increment]
  message_id       bigint [not null, ref: > message.id]
  file_url         varchar(500) [not null]
  mime_type        varchar(100)
}

Table announcement {
  id               bigint [pk, increment]
  author_id        bigint [not null, ref: > users.id] // 관리자 또는 판매자
  audience         varchar(20) [not null, note: 'AnnouncementAudience'] // ALL/SELLER/CONSUMER
  popup_id         bigint [ref: > popup.id] // 고객 공지인 경우 지정 가능
  title            varchar(200) [not null]
  content          text
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (audience, popup_id, created_at) [name: "idx_announce_scope"]
  }
}

// =========================
// AI Recommendation
// =========================
Table daily_consumer_recommendation {
  id                    bigint [pk, increment]
  consumer_id           bigint [not null, ref: > users.id]
  popup_id              bigint [not null, ref: > popup.id]
  recommendation_date   date [not null]
  score                 decimal(6,3) [not null, default: 0]
  model_version         varchar(50)
  reason_json           text
  Indexes {
    (consumer_id, recommendation_date, popup_id) [unique, name: "uk_dcr_dedup"]
  }
}

Table user_reco_dismissal {
  id               bigint [pk, increment]
  consumer_id      bigint [not null, ref: > users.id]
  date             date [not null]
  popup_id         bigint [not null, ref: > popup.id]
  dismissed_at     datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (consumer_id, date, popup_id) [unique, name: "uk_reco_dismiss"]
  }
}

Table daily_seller_recommendation {
  id                    bigint [pk, increment]
  seller_id             bigint [not null, ref: > users.id]
  zone_area_id          bigint [not null, ref: > zone_area.id]
  recommendation_date   date [not null]
  score                 decimal(6,3) [not null, default: 0]
  model_version         varchar(50)
  reason_json           text
  Indexes {
    (seller_id, recommendation_date, zone_area_id) [unique, name: "uk_dsr_dedup"]
  }
}

// =========================
// Events & Metrics
// =========================
Table event_log {
  id               bigint [pk, increment]
  user_id          bigint [ref: > users.id]
  popup_id         bigint [ref: > popup.id]
  zone_cell_id     bigint [ref: > zone_cell.id]
  action_type      varchar(20) [not null, note: 'EventAction']
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (popup_id, created_at) [name: "idx_evt_popup_time"]
    (zone_cell_id, created_at) [name: "idx_evt_zone_time"]
    (user_id, created_at) [name: "idx_evt_user_time"]
  }
}

Table event_log_category {
  id               bigint [pk, increment]
  user_id          bigint [ref: > users.id]
  category_id      bigint [not null, ref: > category.id]
  action_type      varchar(20) [not null, note: 'EventAction']
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (category_id, created_at) [name: "idx_evt_cat_time"]
  }
}

Table metric_daily_popup {
  id               bigint [pk, increment]
  popup_id         bigint [not null, ref: > popup.id]
  date             date   [not null]
  views            int    [not null, default: 0]
  unique_users     int    [not null, default: 0]
  favorites        int    [not null, default: 0]
  reviews          int    [not null, default: 0]
  Indexes {
    (popup_id, date) [unique, name: "uk_mdp_popup_date"]
  }
}

Table metric_daily_category {
  id               bigint [pk, increment]
  category_id      bigint [not null, ref: > category.id]
  date             date   [not null]
  clicks           int    [not null, default: 0]
  Indexes {
    (category_id, date) [unique, name: "uk_mdc_cat_date"]
  }
}

// =========================
// Approval Audit
// =========================
Table approval_record {
  id               bigint [pk, increment]
  target_type      varchar(20) [not null, note: 'ApprovalTargetType'] // 'POPUP'
  target_id        bigint [not null]
  decision         varchar(20) [not null, note: 'DecisionType']       // APPROVE/REJECT
  reason           varchar(1000)
  admin_id         bigint [not null, ref: > users.id]
  created_at       datetime [default: `CURRENT_TIMESTAMP`]
  Indexes {
    (target_type, target_id, created_at) [name: "idx_approval_target"]
  }
}
