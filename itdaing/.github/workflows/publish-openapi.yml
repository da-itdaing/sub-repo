name: Publish OpenAPI to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches: [ backend, main, master ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'README.md'
      - 'build.gradle.kts'
      - 'settings.gradle.kts'
      - '.github/workflows/publish-openapi.yml'

# Ensure the GITHUB_TOKEN can push to gh-pages
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      HAS_DEPLOY_KEY: ${{ secrets.GH_PAGES_DEPLOY_KEY != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate OpenAPI docs
        run: ./gradlew --no-daemon clean generateOpenApiDocs

      - name: Prepare static Swagger site
        run: |
          mkdir -p site
          cp build/openapi/openapi.yaml site/openapi.yaml
          cat > site/index.html << 'EOF'
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>API Docs</title>
            <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
            <style> body { margin: 0; } </style>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
            <script>
              window.onload = () => {
                window.ui = SwaggerUIBundle({
                  url: 'openapi.yaml',
                  dom_id: '#swagger-ui',
                  presets: [SwaggerUIBundle.presets.apis],
                  layout: 'BaseLayout'
                });
              }
            </script>
          </body>
          </html>
          EOF

      # Option A: Use a deploy key secret if org policy restricts GITHUB_TOKEN write
      - name: Deploy to GitHub Pages (deploy key)
        if: ${{ env.HAS_DEPLOY_KEY == 'true' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          deploy_key: ${{ secrets.GH_PAGES_DEPLOY_KEY }}
          publish_dir: ./site
          publish_branch: gh-pages

      # Option B: Fall back to GITHUB_TOKEN if allowed
      - name: Deploy to GitHub Pages (GITHUB_TOKEN)
        if: ${{ env.HAS_DEPLOY_KEY != 'true' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
